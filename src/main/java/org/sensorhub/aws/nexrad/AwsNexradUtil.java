package org.sensorhub.aws.nexrad;


import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;

import com.amazonaws.AmazonClientException;
import com.amazonaws.AmazonServiceException;
import com.amazonaws.auth.AWSCredentials;
import com.amazonaws.auth.profile.ProfileCredentialsProvider;
import com.amazonaws.regions.Region;
import com.amazonaws.regions.Regions;
import com.amazonaws.services.sns.AmazonSNSClient;
import com.amazonaws.services.sns.util.Topics;
import com.amazonaws.services.sqs.AmazonSQS;
import com.amazonaws.services.sqs.AmazonSQSClient;
import com.amazonaws.services.sqs.model.CreateQueueRequest;
import com.amazonaws.services.sqs.model.DeleteMessageRequest;
import com.amazonaws.services.sqs.model.DeleteQueueRequest;
import com.amazonaws.services.sqs.model.Message;
import com.amazonaws.services.sqs.model.ReceiveMessageRequest;

/**
 * <p>Title: AwsNexradUtil.java</p>
 * <p>Description: </p>
 *
 * @author T
 * @date Feb 3, 2016
 * 
 * Each chunk of each volume scan file is its own object in Amazon S3. The basic data format is the following:
		/<Site>/<Volume_number>/<YYYYMMDD-HHMMSS-CHUNKNUM-CHUNKTYPE>
		Where:
		<Site> is the NEXRAD ground station (map of ground stations)
		<Volume_number> is the volume id number (cycles from 0 to 999)
		<YYYYMMDD> is the date of the volume scan
		<HHMMSS> is the time of the volume scan
		<CHUNKNUM> is the chunk number
		<CHUNKTYPE> is the chunk type
 * 
 */
public class AwsNexradUtil {
	public static final String AWS_NEXRAD_URL = "http://noaa-nexrad-level2.s3.amazonaws.com/";
	public static final String REALTIME_AWS_NEXRAD_URL = "http://unidata-nexrad-level2-chunks.s3.amazonaws.com/";
	public static final String dataBucketStr = "noaa-nexrad-level2";

	public static String getChunkPath(String message) {
		//  Find instance of "key":
		int keyIdx = message.indexOf("key\\\"");
		String s = message.substring(keyIdx);
		int startIdx = s.indexOf("\\\"");
		s = s.substring(startIdx + 5);
		int stopIdx = s.indexOf("\\\"");
		s = s.substring(0, stopIdx);
		
		return s;
	}
	
	public static String getEventTime(String message) {
		//  Find instance of "key":
		int keyIdx = message.indexOf("Time\\\"");
		String s = message.substring(keyIdx);
		int startIdx = s.indexOf("\\\"");
		s = s.substring(startIdx + 5);
		int stopIdx = s.indexOf("\\\"");
		s = s.substring(0, stopIdx);
		
		return s;
	}
	
	
	public static void main(String[] args) throws IOException, InterruptedException {
		AWSCredentials credentials = null;
		try {
			credentials = new ProfileCredentialsProvider().getCredentials();
		} catch (Exception e) {
			throw new AmazonClientException(
					"Cannot load the credentials from the credential profiles file. " +
							"Please make sure that your credentials file is at the correct " +
							"location (~/.aws/credentials), and is in valid format.",
							e);
		}

		AmazonSQS sqs = new AmazonSQSClient(credentials);
		AmazonSNSClient sns = new AmazonSNSClient(credentials);
		Region usWest2 = Region.getRegion(Regions.US_WEST_2);
		sqs.setRegion(usWest2);

		try {
//			ListQueuesResult r = sqs.listQueues();
//			System.err.println(r.toString());
//			GetQueueAttributesRequest qar = new GetQueueAttributesRequest(queueUrl);
			// Create a queue
			System.out.println("Creating a new SQS queue.\n");
			CreateQueueRequest createQueueRequest = new CreateQueueRequest("NexradQueueTest");
			String myQueueUrl = sqs.createQueue(createQueueRequest).getQueueUrl();
			//			sqs.
			String topicArn = "arn:aws:sns:us-east-1:684042711724:NewNEXRADLevel2Object";
//			String topicArn = "arn:aws:sns:us-east-1:811054952067:NewNEXRADLevel2Archive";
			Topics.subscribeQueue(sns, sqs, topicArn, myQueueUrl);

			// Receive messages
			System.out.println("Receiving messages from MyQueue.\n");
			int cnt = 0;
			while(cnt++ < 1000) {
				ReceiveMessageRequest receiveMessageRequest = new ReceiveMessageRequest(myQueueUrl).
						withWaitTimeSeconds(0).withMaxNumberOfMessages(10);
				List<Message> messages = sqs.receiveMessage(receiveMessageRequest).getMessages();
				for (Message message : messages) {
//					System.out.println("  Message");
//					System.out.println("    MessageId:     " + message.getMessageId());
//					System.out.println("    ReceiptHandle: " + message.getReceiptHandle());
//					System.out.println("    MD5OfBody:     " + message.getMD5OfBody());
//					System.out.println("    Body:          " + message.getBody());
					String body = message.getBody();
					String path = getChunkPath(body);
					String time = getEventTime(body);
//					if(path.contains("KLGX"))
					System.err.println(path);
					//					for (Entry<String, String> entry : message.getAttributes().entrySet()) {
//						System.out.println("  Attribute");
//						System.out.println("    Name:  " + entry.getKey());
//						System.out.println("    Value: " + entry.getValue());
//					}
//					MessageAttributeValue val = message.getMessageAttributes().get("key");
//					System.err.println(val.getStringValue());
					// delete message
					sqs.deleteMessage(new DeleteMessageRequest(myQueueUrl, message.getReceiptHandle()));
				}
				System.out.println("NumMsgs = " + messages.size());
			
//				Thread.sleep(100L);
				
			}
			//  destory queue 
			if (sqs != null && myQueueUrl != null) {
				sqs.deleteQueue(new DeleteQueueRequest(myQueueUrl));
				System.out.println("Deleted the queue.");
				sqs.shutdown();
			}
		} catch (AmazonServiceException ase) {
			System.out.println("Caught an AmazonServiceException, which means your request made it " +
					"to Amazon SQS, but was rejected with an error response for some reason.");
			System.out.println("Error Message:    " + ase.getMessage());
			System.out.println("HTTP Status Code: " + ase.getStatusCode());
			System.out.println("AWS Error Code:   " + ase.getErrorCode());
			System.out.println("Error Type:       " + ase.getErrorType());
			System.out.println("Request ID:       " + ase.getRequestId());
		} catch (AmazonClientException ace) {
			System.out.println("Caught an AmazonClientException, which means the client encountered " +
					"a serious internal problem while trying to communicate with SQS, such as not " +
					"being able to access the network.");
			System.out.println("Error Message: " + ace.getMessage());
		}
	}
}
